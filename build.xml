<project name="Hoborg Commons" default="help" basedir=".">

    <property name="dir.base" location="." />
    <property name="dir.build" value="${dir.base}/build" />

    <!-- discover modules and libs -->
    <target name="prepare" depends="clean" description="Prepare folder structure">
        <mkdir dir="${dir.build}" />
    </target>

    <target name="build-phar" depends="prepare" description="Builds phar file">
        <echo message="Copy source files to build folder `${dir.build}`." />
        <copy todir="${dir.build}/phar">
            <fileset dir="${dir.base}">
                <include name="autoload.php"/>
                <include name="conf/*" />
                <include name="htdocs/dashboard.php" />
                <include name="src/*" />
                <include name="templates/*" />
                <include name="widgets/hoborg/*" />
            </fileset>
        </copy>

        <echo message="Minifying php files." />
        <apply executable="php" dir="${dir.build}/phar" force="true">
            <arg value="${dir.base}/bin/phpmini.php" />
            <srcfile />
            <fileset dir="${dir.build}/phar">
                <patternset>
                    <include name="**/*.php"/>
                </patternset>
            </fileset>
        </apply>

        <echo message="Building PHAR file." />
        <exec executable="php" dir="${dir.build}">
            <arg line="${dir.base}/bin/build.php" />
            <arg line="${dir.build}/phar" />
        </exec>
    </target>

    <target name="phpunit">
        <exec dir="${dir.base}" executable="${cmd.phpunit}" failonerror="false">
            <arg line="-c phpunit-cmns.xml" />
            <arg line="--log-junit ${dir.logs}/phpunit/cmns-phpunit.xml" />
        </exec>
    </target>

    <target name="phpmd">
        <exec dir="${dir.base}" executable="phpmd" failonerror="false">
            <arg line="${dir.src}/Hoborg" />
            <arg line="xml" />
            <arg line="codesize,unusedcode,naming" />
            <arg line="--reportfile ${dir.logs}/phpmd/cmns-phpmd.xml" />
        </exec>
    </target>

    <target name="phpcpd">
        <exec dir="${dir.base}" executable="phpcpd" failonerror="false">
            <arg line="--log-pmd ${dir.logs}/phpcpd/cmns-phpcpd.xml" />
            <arg value="${dir.src}/Hoborg" />
        </exec>
    </target>

    <target name="phpcs">
        <exec dir="${dir.base}" executable="phpcs" failonerror="false">
            <arg value="--standard=${dir.base}/misc/code_sniffer/Hoborg/" />
            <arg value="--report=checkstyle" />
            <arg value="--report-file=${dir.logs}/phpcs/cmns-sniffs.xml" />
            <arg value="-p" />
            <arg value="${dir.src}/Hoborg" />
        </exec>
    </target>

    <target name="phpdepend">
        <exec dir="${dir.base}" executable="pdepend" failonerror="false">
            <arg line="--jdepend-chart=${dir.logs}/phpdepend/jdepend.png" />
            <arg line="--jdepend-xml=${dir.logs}/phpdepend/jdepend.xml" />
            <arg line="--overview-pyramid=${dir.logs}/phpdepend/pyramid.svg" />
            <arg line="${dir.src}/Hoborg" />
        </exec>
    </target>

    <!-- Clean up -->
    <target name="clean" description="Clean up workspace">
        <delete dir="${dir.build}" />
    </target>

    <!-- Help Message -->
    <target name="help" description="Prints this help">
        <exec executable="ant">
            <arg value="-p" />
        </exec>
    </target>
</project>

